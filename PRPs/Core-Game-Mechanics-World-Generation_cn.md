# PRP: 核心游戏机制 - 无限世界生成

## 问题陈述
游戏需要一个无限滚动的平台跳跃世界，具有程序生成的地形、障碍物和收集品，在无尽游戏过程中保持一致的挑战性和多样性。

## 需求
- 无限水平世界生成
- 具有不同高度和间隙的程序化平台放置
- 难度递增的动态敌人生成
- 用于得分和收集的金币放置
- 尖刺危险物和障碍物
- 基于区块的生成系统
- 内存管理（清理旧区块）
- 无性能下降的无缝滚动

## 解决方案

### 架构
1. **WorldGenerator**：管理区块生成和清理
2. **区块系统**：世界分为800px宽的区块
3. **平台生成**：随机高度、间隙和模式
4. **敌人/金币生成**：区块内的概率放置
5. **难度缩放**：敌人数量和速度随距离增加

### 世界生成算法
```typescript
generateChunk(chunkIndex) {
  - 计算区块X位置（chunkIndex × chunkWidth）
  - 每个区块生成3-8个平台
  - 随机平台高度（距底部200-500px）
  - 随机平台宽度（100-300px）
  - 平台之间的随机间隙（50-200px）
  - 生成敌人（每个平台20%概率）
  - 生成金币（每个平台40%概率）
  - 生成尖刺（每个平台15%概率）
}
```

### 难度进度
- **敌人数量**：每5个区块增加
- **敌人速度**：每10个区块+10%
- **间隙大小**：随距离略微增加
- **尖刺密度**：后期区块增加
- **Boss战**：每5关（Boss替代常规敌人）

## 实现细节

### 创建/修改的文件
1. **frontend/src/utils/WorldGenerator.ts**
   - generateChunk()：创建平台、敌人、金币、尖刺
   - getChunkIndex()：计算玩家所在的区块
   - cleanupOldChunks()：移除屏幕外的区块
   - Platform类：静态平台对象
   - Enemy类：具有AI的移动敌人
   - Coin类：可收集的货币

2. **frontend/src/scenes/GameScene.ts**
   - create()中的世界生成
   - 更新循环：玩家前进时生成新区块
   - 当区块在玩家后方2屏幕时清理区块
   - 相机跟随：与玩家平滑滚动

### 平台类型
1. **标准平台**：棕色/灰色瓷砖，实心地面
2. **浮动平台**：较高高度，需要跳跃
3. **长平台**：带金币的安全区
4. **短平台**：挑战区，精确跳跃
5. **间隙平台**：相距较远，测试跳跃距离

### 敌人AI集成
- 敌人在平台上巡逻
- 在平台边缘转向
- 可以通过踩踏击败（跳到上面）
- 碰撞时造成伤害
- 生成率随进度增加

### 金币系统
- 放置在平台上和空中
- 重叠时自动收集
- 分数值：每个金币10分
- 视觉反馈：收集时的粒子效果
- 在UI中计数：金币计数器显示

### 尖刺危险物
- 接触时立即造成伤害
- 放置在平台和地面上
- 旋转朝上
- 视觉警告：红色/橙色
- 无法被摧毁

## 技术规格

### 区块配置
```typescript
const CHUNK_CONFIG = {
  width: 800,                    // 每个区块的像素
  platformCount: 3-8,            // 每个区块的随机平台数
  platformHeightRange: [200, 500], // 距地面
  platformWidthRange: [100, 300], // 平台大小
  gapRange: [50, 200],           // 平台之间
  enemySpawnChance: 0.2,         // 每个平台20%
  coinSpawnChance: 0.4,          // 每个平台40%
  spikeSpawnChance: 0.15,        // 每个平台15%
}
```

### 内存管理
- **生成距离**：玩家前方2个区块
- **清理距离**：玩家后方2个区块
- **活动区块**：通常内存中5-7个区块
- **区块池**：重用销毁的对象

### 物理属性
- **平台**：静态物体，不可移动
- **敌人**：动态物体，启用重力
- **金币**：静态触发器，无碰撞
- **尖刺**：静态物体，重叠时造成伤害

## 素材集成
所有素材来自**Kenney素材包**：
- **平台**：`kenney_platformer-art-requests/Tiles/`
  - grassMid.png（标准平台）
  - grassLeft.png / grassRight.png（边缘）
  - stoneMid.png（替代平台）

- **敌人**：`kenney_platformer-art-extended-enemies/Enemy sprites/`
  - slimeWalk1.png / slimeWalk2.png（动画）
  - flyFly1.png / flyFly2.png（飞行敌人）
  - 各种敌人类型和颜色

- **金币**：Kenney UI包中的金币精灵
- **尖刺**：平台跳跃包中的尖刺精灵

## 性能优化
1. **对象池**：重用销毁的平台/敌人/金币
2. **剔除**：只渲染屏幕上的对象
3. **区块批处理**：每帧生成多个平台
4. **纹理图集**：所有素材的单一精灵表
5. **物理优化**：休眠不活动的物体

## 测试与验证
1. **无限生成**：游玩10+分钟，验证无间隙
2. **内存**：长时间会话期间检查内存泄漏
3. **难度曲线**：验证敌人数量适当增加
4. **碰撞检测**：测试平台、敌人、金币、尖刺碰撞
5. **视觉一致性**：无闪烁或缺失素材

## 难度参数
```typescript
getDifficultyMultiplier(distance) {
  enemySpeedMultiplier = 1 + (distance / 10000) * 0.1  // 每10k像素+10%
  enemyCountMultiplier = 1 + Math.floor(distance / 4000) * 0.2 // 每5区块+20%
  gapSizeMultiplier = 1 + (distance / 20000) * 0.1  // 逐渐变宽的间隙
  spikeChanceMultiplier = 1 + (distance / 15000) * 0.05  // 后期更多尖刺
}
```

## 已知问题与解决方案

### 问题：平台间隙过宽
**问题**：玩家因缺少平台而掉落穿过世界

**解决方案**：
- 最小平台重叠检查
- 最大间隙大小限制（200px）
- 检测到间隙时紧急生成平台

### 问题：内存堆积
**问题**：旧区块未正确清理

**解决方案**：
- 在Set中跟踪区块索引
- 删除后方2+屏幕的区块
- 正确释放精灵纹理

### 问题：难度突增
**问题**：游戏难度增加过快

**解决方案**：
- 逐渐增加难度（每5-10个区块）
- 初始"安全区"无敌人
- 难度上限防止不可能

## Boss集成
- **频率**：每5关（第5、10、15、20关...）
- **生成**：在关卡末尾用Boss替代常规敌人
- **平台**：为Boss战生成大型平坦平台
- **难度**：Boss生命值随关卡缩放
- **奖励**：击败后获得额外金币/分数
- **传送门阻挡**：Boss未被击败时关卡末端传送门被阻挡

## 关卡过渡系统
过渡到下一关时，游戏状态被保留：

```typescript
nextLevelData = {
  gameMode: 'levels',
  level: currentLevel + 1,
  lives: playerLives,        // ✅ 跨关卡保留
  score: score,              // ✅ 累积分数继续
  isRecording: isRecordingForDQN,  // ✅ DQN录制持续
  mode: 'coop',              // 如果合作模式激活
  dqnTraining: true          // 如果DQN训练模式激活
}
```

### 保留的状态：
- **生命值**：玩家生命跨关卡保留（不重置为3）
- **分数**：所有关卡累积分数
- **录制**：DQN录制无缝继续
- **游戏模式**：合作和训练模式持续

### 重置的状态：
- **关卡布局**：全新程序生成
- **敌人**：新敌人生成
- **金币**：新金币放置
- **玩家位置**：重置到关卡起点

## 未来改进
- 生态系统（每10关不同视觉主题）
- 天气效果（雨、雪影响物理）
- 移动平台（水平/垂直）
- 可破坏平台（临时表面）
- 秘密区域（隐藏金币/道具）
- 检查点系统（保存进度）
- 程序生成的背景视差层
- 随难度变化的动态音乐

## 状态
✅ **已完成** - 无限世界生成，具有难度缩放、内存管理、Boss战和关卡过渡状态保存
