# PRP: 手柄控制增强

## 问题陈述
游戏需要全面的手柄支持以获得类主机的游戏体验，包括模拟摇杆控制、喷气背包机制和针对平台跳跃游戏优化的按钮映射。

## 需求
- 通过Phaser手柄插件完全支持Xbox/PlayStation控制器
- 带死区处理的模拟摇杆移动
- 带可调灵敏度的右模拟摇杆武器瞄准
- 十字键备用控制（十字键上用于跳跃）
- 持续向上推左摇杆时的喷气背包模式
- 无冲突跳跃动作的正确按钮映射
- 手柄连接的视觉反馈

## 解决方案

### 控制器功能
1. **移动控制**
   - 左模拟摇杆：玩家移动（X轴），0.3死区
   - 左摇杆Y轴（持续向上）：喷气背包飞行行为
   - 十字键：备用移动控制
   - 十字键上：跳跃动作（代替按钮映射）

2. **战斗控制**
   - 右模拟摇杆：武器瞄准，灵敏度降低50%
   - 右扳机（R2）：射击
   - 功能按钮：跳跃、特殊动作

3. **喷气背包机制**
   - 通过持续向上推左摇杆激活
   - 应用向上速度实现飞行行为
   - 飞行时允许水平移动
   - 重力仍然适用但效果减弱

### 灵敏度调整
- 左模拟摇杆：标准灵敏度，0.3死区
- 右模拟摇杆：灵敏度降低50%以实现精确瞄准
- 可通过ControlManager配置

## 实现细节

### 创建/修改的文件
1. **frontend/src/utils/ControlManager.ts**
   - 带按钮/轴映射的GamepadMapping接口
   - 死区处理（移动0.3）
   - 模拟摇杆值处理
   - 从手柄映射中移除跳跃按钮（与十字键冲突）

2. **frontend/src/scenes/GameScene.ts**
   - 喷气背包逻辑：持续向上推左摇杆检测
   - 右摇杆瞄准，灵敏度50%
   - 十字键上映射到跳跃动作
   - 更新循环中的手柄输入处理

### 控制映射
```javascript
GamepadMapping = {
  movement: {
    leftStickX: 0,    // 水平移动
    leftStickY: 1,    // 喷气背包（持续向上）
  },
  aiming: {
    rightStickX: 2,   // 水平瞄准（50%灵敏度）
    rightStickY: 3,   // 垂直瞄准（50%灵敏度）
  },
  buttons: {
    jump: 0,          // A/X按钮
    shoot: 7,         // RT/R2扳机
  },
  dpad: {
    up: 12,          // 跳跃动作
    down: 13,
    left: 14,
    right: 15,
  }
}
```

### 喷气背包行为
- **激活**：左摇杆Y < -0.8（持续向上）
- **效果**：每帧应用向上速度
- **移动**：飞行时仍可水平移动
- **物理**：重力仍适用但被喷气背包力抵消

## 测试与验证
1. **控制器检测**：插入Xbox/PlayStation控制器
2. **移动**：测试左摇杆在所有方向上带死区
3. **瞄准**：验证右摇杆以降低的灵敏度控制武器
4. **喷气背包**：持续向上推左摇杆，玩家应持续飞行
5. **十字键**：按十字键上跳跃
6. **按钮冲突**：确保无重复跳跃触发

## 性能指标
- 死区：0.3（30%防止漂移）
- 右摇杆灵敏度：50%（正常的一半）
- 喷气背包力：激活时每帧应用
- 输入轮询：更新循环中每帧

## 已知问题与解决方案
1. **瞄准过于灵敏**：将右摇杆降至50%灵敏度
2. **跳跃按钮冲突**：从按钮映射中移除跳跃，使用十字键上
3. **控制器漂移**：应用0.3死区防止意外移动
4. **喷气背包过强**：调整向上速度以与重力平衡

## 未来改进
- 可配置的按钮重映射UI
- 模拟摇杆灵敏度滑块
- 振动/震动反馈支持
- 多控制器配置文件
- 屏幕按钮提示

## 状态
✅ **已完成** - 完整手柄支持，具有喷气背包、十字键跳跃和优化的瞄准灵敏度
